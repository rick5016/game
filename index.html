<html>

<head>
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="index.css" />
    <title>todo</title>
</head>

<body>
    <canvas id="canvas" width="800" height="600"></canvas>
    <canvas id="calc" width="800" height="600"></canvas>
    <div id="interface" style="border:solid 1px black;margin-left: 810px;"></div>
    <script src="jquery.min.js"></script>
    <script src="data.js"></script>
    <script src="perso.js"></script>
    <script src="gestion_faim.js"></script>
    <script src="gestion_metier.js"></script>
    <script type="text/javascript">
        var log_active = false;
        var width = 800;
        var height = 600;
        var population = [];
        var time = 0;

        function life() {
            time++;

            var date = new Date();
            var heure = date.getHours();

            var ctx = document.getElementById('calc').getContext('2d');
            clear();
            $.each(familles, function (index, famille) {
                $.each(famille, function (index_famille, perso) {
                    perso = gestion_faim(perso);
                    if (perso.mission == "Aucune") {
                        //perso = gestion_metier(perso);
                    }
                    perso = mission(perso);

                    var img = new Image();
                    img.src = perso.image;
                    perso.img = img;
                    ctx.drawImage(perso.img, perso.x1, perso.y1);
                    drawPopup(perso.x1 + 20, perso.y1 + 20, perso.action);

                    perso.faim -= 0.01;
                });
            });
            drawInterface();
            //setTimeout(life, 100); // 1 sec
            //window.requestAnimationFrame(life);
        }

        function mission(perso) {
            var nourriture_max = 250;
            var pixelParSeconde = 1;
            var d_x = perso.x1; // Coordonnées perso x
            var d_y = perso.y1; // Coordonnées perso y
            var a_x = maisons[perso.maison].x1; // Coordonnées maison x
            var a_y = maisons[perso.maison].y1; // Coordonnées maison y
            var stock_nourriture = maisons[perso.maison].stock;

            if (perso.mission == "Manger") {
                log("Mission : Manger");
                return mange(perso);
            }

            if (perso.mission == "Va manger à la maison") {
                log("Mission : Va manger à la maison");
                return goMaison(perso);
            }

            if (perso.mission == "Va acheter des provisions") {
                log("Mission : Va acheter des provisions");
                return acheter_manger(perso);
            }

            if (perso.mission == "Ramèner les provisions") {
                log("Mission : Ramèner les provisions");
                return deposer_manger(perso);
            }

            if (perso.mission == "Va travailler à l'entrepôt") {
                log("Mission : Va travailler à l'entrepôt");
                return travail_entrepot(perso);
            }

            if (perso.mission == "Va travailler au champ") {
                log("Mission : Va travailler au champ");
                return travail_champ(perso);
            }

            if (perso.mission == "Va déposer le blé à l'entrepôt") {
                log("Mission : Va déposer le blé à l'entrepôt");
                return travail_champ_entrepot(perso);
            }

            perso = ballade(perso);

            return perso;
        }

        function ballade(perso) {
            log("Je me ballade");
            perso.mission = "Aucune";
            perso.action = "Je me ballade";
            var r_x = getRandomInt(800);
            var r_y = getRandomInt(600);
            perso.x1 = calculPath(perso.x1, r_x);
            perso.y1 = calculPath(perso.y1, r_y);
            perso.position = "dehors";

            return perso;
        }

        function go(perso, batiment) {
            log("Je vais à : " + batiment);
            perso.action = "Je vais à : " + batiment;
            perso.x1 = calculPath(perso.x1, batiments[batiment].x1);
            perso.y1 = calculPath(perso.y1, batiments[batiment].y1);
            if (perso.x1 == batiments[batiment].x1 && perso.y1 == batiments[batiment].y1) {
                perso.position = batiment;
            }

            return perso;
        }

        function goMagasin(perso) {
            log("Je vais à l'entrepôt");
            perso.action = "Je vais à l'entrepôt";
            perso.x1 = calculPath(perso.x1, maisons.entrepot.x1);
            perso.y1 = calculPath(perso.y1, maisons.entrepot.y1);
            if (perso.x1 == maisons.entrepot.x1 && perso.y1 == maisons.entrepot.y1) {
                perso.position = "entrepot";
            }

            return perso;
        }

        function goChamp(perso) {
            log('Je vais au champ');
            perso.action = "Je vais au champ";
            perso.x1 = calculPath(perso.x1, maisons.champ.x1);
            perso.y1 = calculPath(perso.y1, maisons.champ.y1);
            if (perso.x1 == maisons.champ.x1 && perso.y1 == maisons.champ.y1) {
                perso.position = "champ";
            }

            return perso;
        }

        function goMaison(perso) {
            log('Je vais à la maison');
            perso.action = "Je vais à la maison";
            perso.x1 = calculPath(perso.x1, maisons[perso.maison].x1);
            perso.y1 = calculPath(perso.y1, maisons[perso.maison].y1);
            if (perso.x1 == maisons[perso.maison].x1 && perso.y1 == maisons[perso.maison].y1) {
                perso.position = "maison";
            }

            return perso;
        }

        function calculPath(d, a) {
            if (d < a) {
                var result = d + 1;
                if (result >= a) {
                    return a;
                } else {
                    return result;
                }
            } else {
                var result = d - 1;
                if (result <= a) {
                    return a;
                } else {
                    return result;
                }
            }
        }
        function getRandomInt(max) {
            return Math.floor(Math.random() * Math.floor(max));
        }

        function clear() {
            var ctx = document.getElementById('calc').getContext('2d');
            ctx.clearRect(0, 0, width, height);
        }

        function drawInterface() {
            var div = document.getElementById('interface');

            div.innerHTML = '<b>Magasin (stock nourriture: ' + maisons.entrepot.stock + ')</b><br />';
            $.each(familles, function (index, famille) {
                div.innerHTML += '<b>' + index + ' (stock nourriture: ' + maisons[famille[0].maison].stock + ')</b><br />';
                $.each(famille, function (index_famille, perso) {
                    html = '<div style="float:left;border:solid 1px black;padding:5px">';
                    html += '<b>' + perso.id + '(' + perso.age + ' ans)</b><br />';
                    html += perso.metier + '<br />';
                    html += '<b>Action:</b><br />' + perso.action + '<br />';
                    html += '<b>Mission:</b><br />' + perso.mission + '<br />';
                    html += '<ul>';
                    //html += '<li>maison: ' + perso.maison + ' (' + maisons[perso.maison].x1 + '/' + maisons[perso.maison].y1 + ')</li>';
                    //html += '<li>personnage: <img src="' + perso.image + '" /> (' + perso.x1 + '/' + perso.y1 + ')</li>';
                    html += '<li>personnage: <img src="' + perso.image + '" /></li>';
                    html += '<li>sexe: ' + perso.sexe + '</li>';
                    //html += '<li>metier: ' + perso.metier + '</li>';
                    //html += '<li>metier_niveau: ' + perso.metier_niveau + '</li>';
                    html += '<li>Stock: ' + parseInt(perso.stock) + '</li>';
                    var faim = parseInt(perso.faim);
                    var niveau_faim = '<span style="color:red">Oui</span>';
                    if (faim > 50) {
                        var niveau_faim = 'Non';
                    } else if (faim < 0) {
                        var niveau_faim = 'Affamé';
                    }
                    if (perso.action == 'Je mange') {
                        var niveau_faim = '<span style="color:green">Mange</span>';
                    }
                    html += '<li>faim: ' + niveau_faim + '(' + faim + ')</li>';
                    html += '</ul>';
                    html += '</div>';
                    div.innerHTML += html;
                });
                div.innerHTML += '<div style="clear:both"></div>';
            });
        }

        function drawPopup(x, y, data) {
            largeur = 10.0;
            hauteur = 10.0;
            var ctx = document.getElementById('calc').getContext('2d');

            ctx.font = '16px serif';
            var text = ctx.measureText(data);

            largeur += text.width;
            hauteur += 16;
            if (x + largeur > width) {
                x -= text.width;
            }
            if (y + hauteur > height) {
                y -= 16;
            }

            ctx.fillStyle = 'rgb(255, 255, 255)';
            ctx.fillRect(x, y, largeur, hauteur);

            ctx.fillStyle = 'rgb(0, 0, 0)';
            ctx.fillText(data, x, y + 16);
        }

        function draw() {
            var ctx = document.getElementById('canvas').getContext('2d');
            $.each(maisons, function (index, maison) {
                var img = new Image();
                img.onload = function () {
                    ctx.drawImage(img, maison.x1, maison.y1);
                };
                img.src = maison.image;
                maison.img = img;
            });

            var ctx = document.getElementById('calc').getContext('2d');
            $.each(familles, function (index, famille) {
                $.each(famille, function (index_famille, data) {
                    population.push(new perso(data));
                });
            });


        }

        /*$(document).on('click', '#calc', function (e) {
            console.log(e.clientX + '/' + e.clientY);
        });*/

        /*$(document).on('mousemove', '#calc', function (e) {
            var inCanvas = false;
            var x = e.clientX;
            var y = e.clientY;
            var ctx = document.getElementById('canvas').getContext('2d');
            $.each(maisons, function (index, maison) {
                if ((x >= maison.x1 && x <= maison.x2) && (y >= maison.y1 && y <= maison.y2)) {
                    inCanvas = true;
                    maison.img.src = maison.image_hover;
                    //drawPopup(x, y, maison.libelle);
                } else {
                    maison.img.src = maison.image;
                }
            });
            if (!inCanvas) {
                //clear();
            }
        });*/

        function log(txt) {
            if (log_active) {
                console.log(txt);
            }
        }

        $(document).ready(function () {
            draw();

            $.each(familles, function (index, famille) {
                $.each(famille, function (index_famille, perso) {
                    var img = new Image();
                    img.src = perso.image;
                    perso.img = img;
                });
            });
            window.requestAnimationFrame(life);
        });




    </script>
</body>

</html>